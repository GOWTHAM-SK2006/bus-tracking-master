<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - DYGON</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="design-system.css">
    <style>
        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
        }
        .auth-container { width: 100%; max-width: 400px; padding: var(--space-4); }
        .auth-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            box-shadow: var(--shadow-md);
        }
        .auth-header { text-align: center; margin-bottom: var(--space-8); }
        .logo {
            width: 48px; height: 48px; margin: 0 auto var(--space-4);
            background: var(--primary-600); border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center; color: white;
            font-size: var(--text-2xl); font-weight: var(--font-bold);
        }
        .auth-title { font-size: var(--text-2xl); font-weight: var(--font-semibold); margin-bottom: var(--space-2); }
        .btn-full { width: 100%; }
        .alert-container { margin-bottom: var(--space-4); }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="6" width="18" height="12" rx="2" />
                        <path d="M3 10h18" />
                        <circle cx="7" cy="16" r="1" fill="currentColor" />
                        <circle cx="17" cy="16" r="1" fill="currentColor" />
                    </svg>
                </div>
                <h1 class="auth-title">Reset Password</h1>
                <p class="auth-subtitle">Enter your new password below</p>
            </div>

            <div class="alert-container" id="alertContainer"></div>

            <form id="resetForm">
                <div class="form-group">
                    <label class="form-label" for="password">New Password</label>
                    <input type="password" id="password" class="form-input" placeholder="••••••••" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="••••••••" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary btn-lg btn-full">Reset Password</button>
            </form>
        </div>
    </div>

    <script>
        function getApiBaseUrl() {
            const host = window.location.hostname;
            const protocol = window.location.protocol;
            if (protocol === 'file:') return 'https://bus-tracking-master-production.up.railway.app';
            if (host.includes('.devtunnels.ms')) {
                const tunnelMatch = host.match(/^([^-]+)-\d+\.(.+)$/);
                if (tunnelMatch) return `${protocol}//${tunnelMatch[1]}-8080.${tunnelMatch[2]}`;
            }
            if (window.location.port) return `${protocol}//${host}:${window.location.port}`;
            return `${protocol}//${host}`;
        }

        const resetForm = document.getElementById('resetForm');
        const alertContainer = document.getElementById('alertContainer');
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        if (!token) {
            showAlert("Invalid or missing token. Please request a new link.", "error");
            resetForm.style.display = 'none';
        }

        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showAlert("Passwords do not match", "error");
                return;
            }

            const submitBtn = e.target.querySelector('button');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';

            try {
                const response = await fetch(`${getApiBaseUrl()}/api/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, newPassword: password })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert("Password reset successfully! Redirecting to login...", "success");
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showAlert(data.message || "Reset failed", "error");
                }
            } catch (error) {
                console.error(error);
                showAlert("Something went wrong. Please try again.", "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        });
    </script>
</body>
</html>
