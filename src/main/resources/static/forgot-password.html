<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forgot Password - DYGON</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="design-system.css" />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"
    ></script>
    <style>
      body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
      }
      .auth-container {
        width: 100%;
        max-width: 400px;
        padding: var(--space-4);
      }
      .auth-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: var(--space-8);
        box-shadow: var(--shadow-md);
      }
      .auth-header {
        text-align: center;
        margin-bottom: var(--space-8);
      }
      .logo {
        width: 48px;
        height: 48px;
        margin: 0 auto var(--space-4);
        background: var(--primary-600);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
      }
      .auth-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-semibold);
        margin-bottom: var(--space-2);
      }
      .auth-subtitle {
        font-size: var(--text-sm);
        color: var(--text-secondary);
      }
      .btn-full {
        width: 100%;
      }
      .alert-container {
        margin-bottom: var(--space-4);
      }
      .back-link {
        margin-top: var(--space-6);
        text-align: center;
        font-size: var(--text-sm);
      }
      .back-link a {
        color: var(--primary-600);
        text-decoration: none;
        font-weight: var(--font-medium);
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <div class="logo">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="6" width="18" height="12" rx="2" />
              <path d="M3 10h18" />
              <circle cx="7" cy="16" r="1" fill="currentColor" />
              <circle cx="17" cy="16" r="1" fill="currentColor" />
            </svg>
          </div>
          <h1 class="auth-title">Forgot Password</h1>
          <p class="auth-subtitle">Enter your email to receive a reset link</p>
        </div>

        <div class="alert-container" id="alertContainer"></div>

        <form id="forgotForm">
          <div class="form-group">
            <label class="form-label" for="email">Email address</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="you@example.com"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary btn-lg btn-full">
            Send Reset Link
          </button>
        </form>

        <div class="back-link">
          <a href="login.html">Back to login</a>
        </div>
        
        <!-- Debug Helper -->
        <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px;">
          <p style="font-size: 10px; color: #666; margin-bottom: 5px;">Debug Tools:</p>
          <button type="button" onclick="testConnection()" class="btn btn-secondary btn-sm" style="width: 100%; font-size: 12px;">Test Server Connection</button>
        </div>
      </div>
    </div>

    <script>
      async function testConnection() {
        const baseUrl = getApiBaseUrl();
        const testUrl = `${baseUrl}/api/auth/test`;
        console.log(`[Debug] Testing connection to: ${testUrl}`);
        try {
          const res = await fetch(testUrl);
          const text = await res.text();
          alert(`Success! Backend response: ${text}`);
          console.log("[Debug] Connection Success:", text);
        } catch (err) {
          alert(`Fail! Could not reach ${testUrl}. Error: ${err.message}`);
          console.error("[Debug] Connection Fail:", err);
        }
      }
      (function () {
        emailjs.init("CyQQT9cI3LkDf5s8A");
      })();

      function getApiBaseUrl() {
        const host = window.location.hostname;
        const protocol = window.location.protocol;
        if (protocol === "file:") return "http://localhost:8080";
        if (host.includes(".devtunnels.ms")) {
          const tunnelMatch = host.match(/^([^-]+)-\d+\.(.+)$/);
          if (tunnelMatch)
            return `${protocol}//${tunnelMatch[1]}-8080.${tunnelMatch[2]}`;
        }
        if (window.location.port)
          return `${protocol}//${host}:${window.location.port}`;
        return `${protocol}//${host}`;
      }

      const forgotForm = document.getElementById("forgotForm");
      const alertContainer = document.getElementById("alertContainer");

      function showAlert(message, type) {
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      }

      forgotForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const submitBtn = e.target.querySelector("button");
        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";

        try {
          console.log(`[ForgotPW] Requesting reset for: ${email}`);
          const response = await fetch(
            `${getApiBaseUrl()}/api/auth/forgot-password`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            },
          );

          const data = await response.json();
          console.log("[ForgotPW] Backend response:", data);

          if (response.ok && data.resetLink) {
            console.log("[ForgotPW] Sending email via EmailJS...");
            // Send Email via EmailJS
            const fullLink = `${window.location.origin}/${data.resetLink}`;
            console.log("[ForgotPW] Reset link:", fullLink);

            await emailjs.send("service_qpdndnd", "template_l7nz8ut", {
              user_email: email,
              reset_link: fullLink,
            }).then(
              (response) => {
                console.log("[EmailJS] SUCCESS!", response.status, response.text);
                showAlert("Reset link sent successfully to your email!", "success");
              },
              (error) => {
                console.error("[EmailJS] FAILED...", error);
                showAlert(`Email failed to send: ${error.text || error.message || 'Check EmailJS config'}`, "error");
              }
            );
          } else {
            console.warn("[ForgotPW] No resetLink in response. User might not exist or email is not set.");
            showAlert("DEBUG: User not found in database. Note: Database resets every time you restart the server!", "error");
          }

          showAlert(
            "If this email exists, a reset link has been sent.",
            "success",
          );
          forgotForm.reset();
        } catch (error) {
          console.error("[ForgotPW] Error:", error);
          showAlert("Something went wrong. Please try again.", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Send Reset Link";
        }
      });
    </script>
  </body>
</html>
