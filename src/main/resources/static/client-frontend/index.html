<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="DYGON - Real-time bus tracking for your city"
    />
    <title>DYGON - Client Panel</title>

    <!-- MapTiler SDK CSS -->
    <link
      href="https://cdn.maptiler.com/maptiler-sdk-js/latest/maptiler-sdk.css"
      rel="stylesheet"
    />

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Design System -->
    <link rel="stylesheet" href="../design-system.css" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="./style.css" />
    <link rel="icon" href="./logo.png" />
  </head>

  <body>
    <script>
      // Check for session immediately
      const clientSession = sessionStorage.getItem("client");
      if (!clientSession) {
        window.location.href = "login.html";
      }
    </script>
    <!-- Header -->
    <header class="header">
      <div class="header-container">
        <!-- Logo -->
        <div class="logo">
          <img src="logo.png" alt="DYGON" style="height: 45px; width: auto" />
        </div>

        <!-- Navigation Tabs moved to bottom bar -->

        <!-- Search Bar -->
        <div class="search-container">
          <div class="search-wrapper">
            <svg
              class="search-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="Search for a bus route(bus name)"
              autocomplete="off"
            />
            <button class="search-clear hidden" id="searchClear">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
          <!-- Search Dropdown -->
          <div class="search-dropdown" id="searchDropdown">
            <div class="dropdown-content" id="searchDropdownContent"></div>
          </div>
        </div>

        <!-- Logout Button -->
        <button
          id="logoutBtn"
          onclick="logout()"
          title="Logout"
          style="
            flex-shrink: 0;
            margin-left: auto;
            background: transparent;
            border: 1px solid var(--border-light);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: var(--danger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
          "
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>

      <!-- Connection Status -->
      <div class="connection-badge" id="connectionBadge">
        <span class="badge-dot"></span>
        <span class="badge-text">Connecting...</span>
      </div>

      <!-- Map Controls removed: Traffic and Routes -->
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Persistent Map Background -->
      <div class="map-background">
        <div id="map" class="map-container"></div>
      </div>

      <!-- Active Bus Counter Widget (Bottom Left) -->
      <div class="bus-counter-widget">
        <div class="counter-icon">ðŸšŒ</div>
        <div class="counter-info">
          <span class="counter-value" id="activeBusCount">0</span>
          <span class="counter-label">Active Buses</span>
        </div>
      </div>

      <!-- Map Controls Layer (Bus Info Panel) -->
      <div class="map-overlays" id="mapOverlays">
        <!-- Selected Bus Panel (Right Side) -->
        <div class="bus-info-panel" id="busInfoPanel">
          <button class="panel-close-btn" id="panelCloseBtn">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
          <div class="panel-header">
            <div class="bus-badge-large" id="panelBusNo">--</div>
            <div class="bus-details">
              <div class="bus-name-large" id="panelBusName">Select a bus</div>
              <div class="bus-route-label" id="panelBusRoute">Route: --</div>
              <div class="bus-status active">
                <span class="status-dot"></span>
                <span>Active</span>
              </div>
            </div>
          </div>
          <div class="panel-body">
            <div class="info-row">
              <span class="info-value" id="panelLocation">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">ðŸ‘¤ Driver</span>
              <span class="info-value" id="panelDriver">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">ðŸ“ž Phone</span>
              <span class="info-value" id="panelPhone">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dummy Map Tab (to keep tab logic working for now) -->
      <section
        class="tab-content active"
        id="mapView"
        style="display: none"
      ></section>

      <!-- Buses List Panel (Left Side Overlay) -->
      <section class="floating-panel" id="busesView">
        <div class="panel-container">
          <div class="list-header">
            <h2>All Buses</h2>
            <span class="list-count"><span id="totalBuses">0</span> buses</span>
          </div>
          <!-- Search within list -->
          <div class="local-search">
            <svg
              class="search-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input
              type="text"
              placeholder="Filter buses..."
              id="busFilterInput"
            />
          </div>
          <div class="cards-grid" id="busGrid">
            <div class="empty-state" id="busesEmpty">
              <div class="empty-icon">ðŸšŒ</div>
              <h3>No buses available</h3>
              <p>Waiting for bus data from server...</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
      <div class="loading-content">
        <div class="loading-logo">
          <div class="loading-icon">ðŸšŒ</div>
        </div>
        <div class="loading-text">Loading DYGON...</div>
        <div class="loading-bar">
          <div class="loading-progress"></div>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Welcome Search Modal -->
    <div
      id="welcomeSearchModal"
      class="modal-overlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-card"
        style="
          background: white;
          padding: 2.5rem;
          border-radius: 20px;
          width: 90%;
          max-width: 440px;
          box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
          text-align: center;
        "
      >
        <div style="margin-bottom: 2rem">
          <div
            style="
              width: 60px;
              height: 60px;
              background: #e0e7ff;
              color: #4f46e5;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 1.5rem;
            "
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"
              />
              <circle cx="7" cy="17" r="2" />
              <path d="M9 17h6" />
              <circle cx="17" cy="17" r="2" />
            </svg>
          </div>
          <h2
            style="
              font-size: 1.75rem;
              font-weight: 700;
              color: #1a1a1a;
              margin-bottom: 0.75rem;
              font-family: &quot;Inter&quot;, sans-serif;
            "
          >
            Find Your Bus
          </h2>
          <p style="color: #6b7280; font-size: 1rem; line-height: 1.5">
            Enter the Bus Number or Route Name<br />to start tracking.
          </p>
        </div>

        <form
          id="welcomeSearchForm"
          style="display: flex; flex-direction: column; gap: 1rem"
        >
          <div style="position: relative">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="
                position: absolute;
                left: 16px;
                top: 50%;
                transform: translateY(-50%);
                color: #9ca3af;
              "
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input
              type="text"
              id="welcomeSearchInput"
              placeholder="e.g. Route 45, Bus 101"
              required
              autocomplete="off"
              style="
                width: 100%;
                padding: 14px 14px 14px 48px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 1rem;
                transition: all 0.2s;
                outline: none;
                font-family: &quot;Inter&quot;, sans-serif;
                background: #f9fafb;
              "
            />

            <!-- Welcome Search Dropdown -->
            <div
              id="welcomeSearchDropdown"
              style="
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border-radius: 12px;
                margin-top: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                z-index: 10000;
                overflow: hidden;
                display: none;
                border: 1px solid #f3f4f6;
                max-height: 200px;
                overflow-y: auto;
              "
            >
              <div id="welcomeSearchDropdownContent"></div>
            </div>
          </div>

          <button
            type="submit"
            style="
              background: #4f46e5;
              color: white;
              border: none;
              padding: 16px;
              font-size: 1rem;
              font-weight: 600;
              border-radius: 12px;
              cursor: pointer;
              transition: all 0.2s;
              box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            "
          >
            Start Tracking
          </button>
        </form>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirmModal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #1e1e2e;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          padding: 28px 24px;
          max-width: 380px;
          width: 90%;
          text-align: center;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          animation: modalPop 0.25s ease;
        "
      >
        <div
          id="confirmIcon"
          style="
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 28px;
          "
        ></div>
        <h3
          id="confirmTitle"
          style="
            color: #fff;
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 8px;
          "
        ></h3>
        <p
          id="confirmMessage"
          style="
            color: #a1a1aa;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 24px;
          "
        ></p>
        <div style="display: flex; gap: 12px">
          <button
            id="confirmCancel"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: 1px solid rgba(255, 255, 255, 0.15);
              background: transparent;
              color: #fff;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
          >
            Cancel
          </button>
          <button
            id="confirmAction"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: none;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            "
          ></button>
        </div>
      </div>
    </div>
    <style>
      @keyframes modalPop {
        from {
          opacity: 0;
          transform: scale(0.9) translateY(10px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      #confirmCancel:hover {
        background: rgba(255, 255, 255, 0.1);
      }
    </style>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav" id="bottomNav">
      <button class="bottom-nav-btn active" data-tab="map">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" />
          <line x1="8" y1="2" x2="8" y2="18" />
          <line x1="16" y1="6" x2="16" y2="22" />
        </svg>
        <span>Live Map</span>
      </button>
      <button class="bottom-nav-btn" data-tab="buses">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="6" width="18" height="12" rx="2" />
          <circle cx="7" cy="18" r="2" />
          <circle cx="17" cy="18" r="2" />
        </svg>
        <span>Buses</span>
      </button>
      <button
        class="bottom-nav-btn"
        data-tab="profile"
        onclick="window.location.href = 'profile.html'"
      >
        <div
          id="navProfilePhoto"
          style="
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: white;
            background-size: cover;
            background-position: center;
          "
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
          </svg>
        </div>
        <span>Profile</span>
      </button>
    </nav>

    <!-- MapTiler SDK JS -->
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/latest/maptiler-sdk.umd.js"></script>

    <!-- App JS -->
    <script src="./services.js"></script>
    <script src="./app.js"></script>
    <script>
      function showConfirmDialog({
        title,
        message,
        icon,
        iconBg,
        btnText,
        btnColor,
        onConfirm,
      }) {
        const modal = document.getElementById("confirmModal");
        document.getElementById("confirmTitle").textContent = title;
        document.getElementById("confirmMessage").textContent = message;
        document.getElementById("confirmIcon").textContent = icon;
        document.getElementById("confirmIcon").style.background = iconBg;
        const actionBtn = document.getElementById("confirmAction");
        actionBtn.textContent = btnText;
        actionBtn.style.background = btnColor;
        actionBtn.style.color = "#fff";
        modal.style.display = "flex";

        document.getElementById("confirmCancel").onclick = () => {
          modal.style.display = "none";
        };
        actionBtn.onclick = () => {
          modal.style.display = "none";
          onConfirm();
        };
        modal.onclick = (e) => {
          if (e.target === modal) modal.style.display = "none";
        };
      }

      function logout() {
        showConfirmDialog({
          title: "Logout",
          message:
            "Are you sure you want to logout? You will need to sign in again to access your account.",
          icon: "ðŸšª",
          iconBg: "rgba(251, 146, 60, 0.15)",
          btnText: "Logout",
          btnColor: "#f97316",
          onConfirm: () => {
            sessionStorage.removeItem("client");
            window.location.href = "login.html";
          },
        });
      }

      // Display profile photo in bottom nav from session
      const client = JSON.parse(sessionStorage.getItem("client"));
      if (client && client.profilePicture) {
        const navPhoto = document.getElementById("navProfilePhoto");
        if (navPhoto) {
          navPhoto.style.backgroundImage = `url('${client.profilePicture}')`;
          navPhoto.innerHTML = ""; // Remove default SVG icon
        }
      }
    </script>
  </body>
</html>
