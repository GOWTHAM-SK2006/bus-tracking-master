<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="DYGON Admin - Manage drivers and buses" />
    <title>DYGON Admin Panel</title>

    <!-- MapTiler SDK CSS -->
    <link
      href="https://cdn.maptiler.com/maptiler-sdk-js/latest/maptiler-sdk.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom Styles (cache-busted so latest UI loads) -->
    <link rel="stylesheet" href="./admin-style.css?v=3" />
    <link rel="icon" href="../logo.png" />
  </head>

  <body>
    <script>
      // Check for admin session
      const adminSessionStr = sessionStorage.getItem("admin");
      if (!adminSessionStr) {
        window.location.href = "admin-login.html";
      } else {
        try {
          const adminSession = JSON.parse(adminSessionStr);
          // We'll update UI in admin-app.js or on DOMContentLoaded
          document.addEventListener("DOMContentLoaded", () => {
            const nameDisplay = document.getElementById("adminNameDisplay");
            if (nameDisplay)
              nameDisplay.textContent = adminSession.name || "Admin";
          });
        } catch (e) {
          console.error("Session parse error", e);
          window.location.href = "admin-login.html";
        }
      }
    </script>

    <!-- Header -->
    <header class="admin-header">
      <div class="header-container">
        <!-- Logo -->
        <div class="logo">
          <img src="../logo.png" alt="DYGON" class="logo-img" />
        </div>

        <!-- Mobile Menu Toggle -->
        <button
          class="mobile-menu-btn"
          id="mobileMenuBtn"
          aria-label="Toggle Navigation"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>

        <!-- Navigation Tabs moved to bottom bar -->

        <!-- Admin Actions -->
        <div class="header-actions" id="adminHeaderActions">
          <!-- Account Creation Toggle -->
          <div class="toggle-container">
            <span>Driver Signup</span>
            <button
              id="accountToggleBtn"
              class="toggle-btn"
              onclick="toggleAccountCreation()"
            >
              <span class="toggle-slider"></span>
            </button>
          </div>

          <button id="adminLogoutBtn" onclick="adminLogout()" title="Logout">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
      </div>

      <!-- Connection Status -->
      <div class="connection-badge" id="connectionBadge">
        <span class="badge-dot"></span>
        <span class="badge-text">Connecting...</span>
      </div>
    </header>

    <!-- Admin Main Content (Refactored for Map Layout) -->
    <main class="admin-main">
      <!-- Persistent Map Background -->
      <div class="map-background">
        <div id="map" class="map-container"></div>
      </div>

      <!-- Active Bus Counter Widget (Bottom Left) -->
      <div class="bus-counter-widget">
        <div class="counter-icon">üöå</div>
        <div class="counter-info">
          <div class="counter-top">
            <span class="counter-number" id="activeBusCount">0</span>
            <span class="counter-status">Active</span>
          </div>
          <span class="counter-label">ACTIVE BUSES</span>
        </div>
      </div>

      <!-- Map Overlays -->
      <div class="map-overlays" id="mapOverlays">
        <!-- Selected Bus Panel (Right Side) -->
        <div class="bus-info-panel" id="busInfoPanel">
          <button class="panel-close-btn" id="panelCloseBtn">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div class="panel-header">
            <div class="bus-badge-large" id="panelBusNo">--</div>
            <div class="bus-details">
              <div class="bus-name-large" id="panelBusName">Select a bus</div>
              <div class="bus-route-label" id="panelBusRoute">Route: --</div>
              <div class="bus-status active">
                <span class="status-dot"></span>
                <span>Active</span>
              </div>
            </div>
          </div>
          <div class="panel-body">
            <div class="info-row">
              <span class="info-value" id="panelLocation">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">üë§ Driver</span>
              <span class="info-value" id="panelDriver">--</span>
            </div>
            <div class="info-row">
              <span class="info-label">üìû Phone</span>
              <span class="info-value" id="panelPhone">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Panel (Floating Overlay) -->
      <section class="floating-panel" id="dashboardView">
        <div class="panel-container">
          <div class="list-header">
            <h2>Bus Dashboard</h2>
            <button
              class="close-panel-btn"
              onclick="toggleDashboardPanel(false)"
            >
              √ó
            </button>
          </div>

          <!-- Bus Selector -->
          <div class="dashboard-selector">
            <label for="dashboardBusSearch" class="selector-label"
              >Search Bus:</label
            >
            <div class="selector-wrapper">
              <input
                type="text"
                id="dashboardBusSearch"
                class="form-input selector-input"
                placeholder="Type bus number or route name..."
                autocomplete="off"
              />
              <svg
                class="selector-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <div id="dashboardBusDropdown" class="selector-dropdown">
                <!-- Dropdown items will be populated here -->
              </div>
            </div>
          </div>

          <!-- GPS Data Display -->
          <div
            id="dashboardDataContainer"
            class="dashboard-data-container"
            style="display: none"
          >
            <!-- Bus Info Header -->
            <div class="dash-bus-header">
              <h3 class="dash-bus-number" id="dashBusNumber">--</h3>
              <p class="dash-bus-route" id="dashBusRoute">Route: --</p>
            </div>

            <!-- Status Cards Grid -->
            <div class="dash-stats-grid">
              <!-- GPS Status -->
              <div class="dash-card">
                <div class="dash-label">GPS Status</div>
                <div class="dash-value success" id="dashGpsStatus">--</div>
              </div>

              <!-- Tracking Status -->
              <div class="dash-card">
                <div class="dash-label">Tracking</div>
                <div class="dash-value info" id="dashTrackingStatus">--</div>
              </div>

              <!-- Updates Sent -->
              <div class="dash-card">
                <div class="dash-label">Updates Sent</div>
                <div class="dash-value warning" id="dashUpdatesSent">0</div>
              </div>

              <!-- Last Update -->
              <div class="dash-card">
                <div class="dash-label">Last Update</div>
                <div class="dash-value active" id="dashLastUpdate">--</div>
              </div>
            </div>

            <!-- GPS Coordinates -->
            <div class="dash-section">
              <h4 class="dash-section-title">GPS Coordinates</h4>

              <div class="dash-list">
                <!-- Latitude -->
                <div class="dash-list-item">
                  <span class="dash-list-label">Latitude:</span>
                  <span class="dash-list-value monospace" id="dashLatitude"
                    >--</span
                  >
                </div>

                <!-- Longitude -->
                <div class="dash-list-item">
                  <span class="dash-list-label">Longitude:</span>
                  <span class="dash-list-value monospace" id="dashLongitude"
                    >--</span
                  >
                </div>

                <!-- Accuracy -->
                <div class="dash-list-item">
                  <span class="dash-list-label">Accuracy:</span>
                  <span class="dash-list-value success" id="dashAccuracy"
                    >--</span
                  >
                </div>
              </div>
            </div>

            <!-- Driver Info -->
            <div class="dash-section">
              <h4 class="dash-section-title">Driver Information</h4>

              <div class="dash-list">
                <div class="dash-list-item">
                  <span class="dash-list-label">Name:</span>
                  <span class="dash-list-value" id="dashDriverName">--</span>
                </div>
                <div class="dash-list-item">
                  <span class="dash-list-label">Phone:</span>
                  <span class="dash-list-value" id="dashDriverPhone">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="floating-panel" id="busesView">
        <div class="panel-container">
          <div class="list-header">
            <h2>Registered Buses</h2>
            <span class="list-count"><span id="totalBuses">0</span> buses</span>
            <button class="close-panel-btn" onclick="toggleBusesPanel(false)">
              √ó
            </button>
          </div>
          <!-- Search within list -->
          <div class="local-search">
            <input
              type="text"
              placeholder="Filter buses..."
              id="busFilterInput"
            />
          </div>
          <div class="buses-table-container">
            <table class="buses-table">
              <thead>
                <tr>
                  <th>Bus No</th>
                  <th>Driver</th>
                  <th>Route</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="busesTableBody">
                <!-- Buses will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Export Panel (Floating Overlay) -->
      <section class="floating-panel" id="exportView">
        <div class="panel-container">
          <div class="list-header">
            <h2>Reports & Exports</h2>
            <button class="close-panel-btn" onclick="toggleExportPanel(false)">
              √ó
            </button>
          </div>

          <div class="export-options">
            <div class="export-card">
              <div class="export-icon">üöå</div>
              <h3>Export Active Buses</h3>
              <p>Download a PDF report of currently active buses only.</p>
              <button
                class="btn btn-secondary"
                onclick="exportActiveBusesPDF()"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download PDF
              </button>
            </div>

            <div class="export-card">
              <div class="export-icon">üóìÔ∏è</div>
              <h3>Export by Date Range</h3>
              <p>
                Download a PDF report for buses within a specific date range.
              </p>
              <div class="export-dates">
                <div class="export-date-field">
                  <label>Start Date</label>
                  <input type="date" id="exportStartDate" />
                </div>
                <div class="export-date-field">
                  <label>End Date</label>
                  <input type="date" id="exportEndDate" />
                </div>
              </div>
              <button class="btn btn-secondary" onclick="exportDateRangePDF()">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download PDF
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal for Request Details -->
    <div class="modal" id="requestModal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeRequestModal()">
          &times;
        </button>
        <div id="modalBody"></div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav" id="bottomNav">
      <button class="bottom-nav-btn" data-tab="dashboard">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>Dashboard</span>
      </button>
      <button class="bottom-nav-btn active" data-tab="map">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" />
          <line x1="8" y1="2" x2="8" y2="18" />
          <line x1="16" y1="6" x2="16" y2="22" />
        </svg>
        <span>Live Map</span>
      </button>
      <button class="bottom-nav-btn" data-tab="buses">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="6" width="18" height="12" rx="2" />
          <circle cx="7" cy="18" r="2" />
          <circle cx="17" cy="18" r="2" />
        </svg>
        <span>Buses</span>
      </button>
      <button class="bottom-nav-btn" data-tab="export">
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span>Export</span>
      </button>
      <button
        class="bottom-nav-btn"
        data-tab="profile"
        onclick="window.location.href = 'admin-profile.html'"
      >
        <svg
          width="22"
          height="22"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Profile</span>
      </button>
    </nav>

    <!-- MapTiler SDK JS -->
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/latest/maptiler-sdk.umd.js"></script>

    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Admin Scripts -->
    <script src="./admin-app.js"></script>
  </body>
</html>
